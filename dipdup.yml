spec_version: 1.2
package: landex

database:
  kind: sqlite
  path: landex.sqlite3

# Contracts on mainnet
contracts:
  tezlandItems:
    address: KT1QTdMcE76qfGtJiU25UCUxznkZz2Z7byoS
    typename: tezlandFA2Fungible

  tezlandItemsV2:
    address: KT1FKjrGJoRCTaptCgforuPCPYZsy6hEFri6
    typename: tezlandFA2FungibleV2

  tezlandPlaces:
    address: KT1XoLJEsViee2xzjWiryi3yJ7MErdpWH4Nv
    typename: tezlandFA2NFT

  tezlandPlacesV2:
    address: KT1VwwuuPc3GnCMyRcQ6P9WadAhmx8PGDeQU
    typename: tezlandFA2NFTV2

  tezlandInteriors:
    address: KT1FgfAeYheuSHrqocaxJDN7vjuePVD8vcL6
    typename: tezlandFA2NFTV2

  tezlandDAO:
    address: KT1E15skLoXuD2A12Wws8fn3VdNzXMZW9TUS
    typename: tezlandDAO

  tezlandWorld:
    address: KT1SUuBch2hmWVcQpqo21MJFneN3T1ex4bHx
    typename: tezlandWorld

  tezlandWorldV2:
    address: KT1QE4rhSnwxWA4i9xBhXdrTQGcUGo7to8Z4
    typename: tezlandWorldV2
    
  tezlandMinter:
    address: KT1VqSDzgykqEYMGhW3v1gF82c5fcphC16mt
    typename: tezlandMinter

  tezlandMinterV2:
    address: KT1RptCbehRZQt52BshauxkQfS82fh4eHjL7
    typename: tezlandMinterV2

  tezlandDutchAuctions:
    address: KT1VFAVatCqvMJxcWYrQgX2YNqBmdTiccZS4
    typename: tezlandDutchAuctions

  tezlandDutchAuctionsV2:
    address: KT1QcZ8V7wDUk7BmHj43jVYkA4bkbzsrBJjh
    typename: tezlandDutchAuctionsV2
    
  tezlandFactory:
    address: KT1TLFpn5e3nRvKUNaDp3S5wxkYVzmc9z29L
    typename: tezlandFactory
    
  tezlandRegistry:
    address: KT1NPGNTMvFMjWhMn6C8SSd8JLaxVKLTQyQT
    typename: tezlandRegistry

datasources:
  tzkt_mainnet:
    kind: tzkt
    url: ${TZKT_URL:-https://api.tzkt.io}

# TEMP: For now on rollback wipe and reindex
advanced:
  reindex:
    rollback: wipe
    schema_modified: wipe
    # alternatively to rollback reindex we could also emit a
    # manual type and wipe on that.
    #manual: wipe

# NOTE: indexes are mutable and independent of each other,
# so they need to contain all their dependencies.
indexes:
  tezland_mainnet:
    kind: operation
    datasource: tzkt_mainnet
    contracts: 
      - tezlandMinter
      - tezlandItems
      - tezlandItemsV2
      - tezlandPlaces
      - tezlandInteriors
      - tezlandPlacesV2
      - tezlandDutchAuctions
      - tezlandDutchAuctionsV2
      - tezlandWorld
      - tezlandWorldV2
    handlers:
      # World V2
      - callback: world_v2.on_place_items
        pattern:
          - type: transaction
            destination: tezlandWorldV2
            entrypoint: place_items
      - callback: world_v2.on_remove_items
        pattern:
          - type: transaction
            destination: tezlandWorldV2
            entrypoint: remove_items
      - callback: world_v2.on_set_item_data
        pattern:
          - type: transaction
            destination: tezlandWorldV2
            entrypoint: set_item_data
      - callback: world_v2.on_get_item
        pattern:
          - type: transaction
            destination: tezlandWorldV2
            entrypoint: get_item
      - callback: world_v2.on_set_permissions
        pattern:
          - type: transaction
            destination: tezlandWorldV2
            entrypoint: set_permissions
      - callback: world_v2.on_migration
        pattern:
          - type: transaction
            destination: tezlandWorldV2
            entrypoint: migration

      # World
      - callback: world.on_place_items
        pattern:
          - type: transaction
            destination: tezlandWorld
            entrypoint: place_items
      - callback: world.on_remove_items
        pattern:
          - type: transaction
            destination: tezlandWorld
            entrypoint: remove_items
      - callback: world.on_set_item_data
        pattern:
          - type: transaction
            destination: tezlandWorld
            entrypoint: set_item_data
      - callback: world.on_get_item
        pattern:
          - type: transaction
            destination: tezlandWorld
            entrypoint: get_item

      # Dutch auctions V2
      - callback: dutch_auction_v2.on_create
        pattern:
          - type: transaction
            destination: tezlandDutchAuctionsV2
            entrypoint: create
      - callback: dutch_auction_v2.on_cancel
        pattern:
          - type: transaction
            destination: tezlandDutchAuctionsV2
            entrypoint: cancel
      - callback: dutch_auction_v2.on_bid
        pattern:
          - type: transaction
            destination: tezlandDutchAuctionsV2
            entrypoint: bid
      - callback: dutch_auction_v2.on_manage_wl
        pattern:
          - type: transaction
            destination: tezlandDutchAuctionsV2
            entrypoint: manage_whitelist

      # Dutch auctions
      - callback: dutch_auction.on_create
        pattern:
          - type: transaction
            destination: tezlandDutchAuctions
            entrypoint: create
      - callback: dutch_auction.on_cancel
        pattern:
          - type: transaction
            destination: tezlandDutchAuctions
            entrypoint: cancel
      - callback: dutch_auction.on_bid
        pattern:
          - type: transaction
            destination: tezlandDutchAuctions
            entrypoint: bid
      - callback: dutch_auction.on_manage_wl
        pattern:
          - type: transaction
            destination: tezlandDutchAuctions
            entrypoint: manage_whitelist

      # FA2 Item
      - callback: on_item_transfer
        pattern:
          - type: transaction
            destination: tezlandItems
            entrypoint: transfer
      - callback: on_item_mint
        pattern:
          - type: transaction
            destination: tezlandItems
            entrypoint: mint
      - callback: on_item_burn
        pattern:
          - type: transaction
            destination: tezlandItems
            entrypoint: burn

      # FA2 Item V2
      - callback: on_item_transfer
        pattern:
          - type: transaction
            destination: tezlandItemsV2
            entrypoint: transfer
      - callback: on_item_v2_mint
        pattern:
          - type: transaction
            destination: tezlandItemsV2
            entrypoint: mint
      - callback: on_item_burn
        pattern:
          - type: transaction
            destination: tezlandItemsV2
            entrypoint: burn

      # FA2 Place
      - callback: on_place_transfer
        pattern:
          - type: transaction
            destination: tezlandPlaces
            entrypoint: transfer
      - callback: on_place_mint
        pattern:
          - type: transaction
            destination: tezlandPlaces
            entrypoint: mint

      # FA2 Place V2
      - callback: on_place_transfer
        pattern:
          - type: transaction
            destination: tezlandPlacesV2
            entrypoint: transfer
      - callback: on_place_mint
        pattern:
          - type: transaction
            destination: tezlandPlacesV2
            entrypoint: mint

      # FA2 Interior
      - callback: on_place_transfer
        pattern:
          - type: transaction
            destination: tezlandInteriors
            entrypoint: transfer
      - callback: on_place_mint
        pattern:
          - type: transaction
            destination: tezlandInteriors
            entrypoint: mint

hooks:
  #retry_metadata:
  #  callback: retry_metadata
  #  atomic: False
  run_backups:
    callback: run_backups
    atomic: False
  #simulate_reorg:
  #  callback: simulate_reorg
  #  atomic: True

jobs:
  #retry_metadata:
  #  hook: retry_metadata
  #  daemon: true
    #interval: 1  # in seconds
  run_backups:
    hook: run_backups
    interval: 1800 # in seconds, 30 minutes
  #simulate_reorg:
  #  hook: simulate_reorg
  #  interval: 90  # in seconds